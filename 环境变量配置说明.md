# 环境变量配置说明

## 概述

本项目使用 `.env` 文件来管理环境变量配置，支持开发、测试和生产环境的不同配置。通过环境变量可以灵活配置服务器行为，而无需修改代码。

## 配置文件

### 主配置文件
- **`.env`**: 实际使用的环境变量文件（不要提交到版本控制）
- **`.env.example`**: 环境变量示例文件（可以提交到版本控制）

### 配置加载
项目使用 `dotenv` 包自动加载 `.env` 文件中的环境变量：

```javascript
require('dotenv').config();
```

## 配置分类

### 1. 服务器基础配置

#### PORT
- **说明**: 服务器监听端口
- **默认值**: 3000
- **示例**: `PORT=3000`
- **用途**: 设置HTTP服务器监听的端口号

#### NODE_ENV
- **说明**: 运行环境标识
- **可选值**: `development`, `production`, `test`
- **默认值**: `development`
- **示例**: `NODE_ENV=production`
- **用途**: 影响日志格式、安全策略、错误处理等行为

### 2. 数据库配置

#### MONGODB_URI
- **说明**: MongoDB数据库连接字符串
- **格式**: `mongodb://[username:password@]host[:port]/database`
- **开发环境示例**: `mongodb://localhost:27017/lyl_dev`
- **生产环境示例**: `mongodb://user:pass@cluster.mongodb.net/lyl`
- **用途**: 指定MongoDB数据库的连接地址和认证信息

#### MONGODB_SSL
- **说明**: 是否启用MongoDB SSL连接
- **类型**: 布尔值
- **默认值**: `false`
- **示例**: `MONGODB_SSL=true`
- **用途**: 生产环境建议启用SSL加密连接

### 3. CORS跨域配置

#### CORS_ORIGIN
- **说明**: 允许跨域访问的源域名
- **开发环境**: `*` (允许所有域名)
- **生产环境**: 具体域名，如 `https://example.com`
- **示例**: `CORS_ORIGIN=https://app.example.com`
- **用途**: 控制哪些前端域名可以访问API

### 4. 限流配置

#### RATE_LIMIT_MAX
- **说明**: 全局限流的最大请求次数
- **默认值**: 100
- **示例**: `RATE_LIMIT_MAX=200`
- **用途**: 每个IP在15分钟时间窗口内的最大请求次数

### 5. 日志配置

#### LOG_LEVEL
- **说明**: 日志记录级别
- **可选值**: `error`, `warn`, `info`, `debug`
- **默认值**: `info`
- **示例**: `LOG_LEVEL=debug`
- **用途**: 控制日志输出的详细程度

### 6. 安全配置

#### CONTENT_SECURITY_POLICY
- **说明**: 内容安全策略开关
- **类型**: 布尔值
- **开发环境**: `false`
- **生产环境**: `true`
- **示例**: `CONTENT_SECURITY_POLICY=true`
- **用途**: 防止XSS攻击，限制资源加载

#### CROSS_ORIGIN_EMBEDDER_POLICY
- **说明**: 跨域嵌入策略开关
- **类型**: 布尔值
- **开发环境**: `false`
- **生产环境**: `true`
- **示例**: `CROSS_ORIGIN_EMBEDDER_POLICY=true`
- **用途**: 增强跨域安全性

### 7. 斗鱼服务配置

#### DOUYU_SCRIPT_PATH
- **说明**: Python脚本路径（Linux环境）
- **默认值**: `/usr/local/server/script/douyu.py`
- **示例**: `DOUYU_SCRIPT_PATH=/opt/scripts/douyu.py`
- **用途**: 指定斗鱼房间信息获取脚本的路径

#### DOUYU_SCRIPT_TIMEOUT
- **说明**: Python脚本执行超时时间（毫秒）
- **默认值**: 15000
- **示例**: `DOUYU_SCRIPT_TIMEOUT=20000`
- **用途**: 防止脚本执行时间过长

### 8. 虎牙服务配置

#### HUYA_SCRIPT_PATH
- **说明**: Python脚本路径（Linux环境）
- **默认值**: `/usr/local/server/script/huya.py`
- **示例**: `HUYA_SCRIPT_PATH=/opt/scripts/huya.py`
- **用途**: 指定虎牙房间信息获取脚本的路径

#### HUYA_SCRIPT_TIMEOUT
- **说明**: Python脚本执行超时时间（毫秒）
- **默认值**: 15000
- **示例**: `HUYA_SCRIPT_TIMEOUT=20000`
- **用途**: 防止脚本执行时间过长

### 9. 性能优化配置

#### COMPRESSION_LEVEL
- **说明**: 响应压缩级别
- **范围**: 1-9
- **默认值**: 6
- **示例**: `COMPRESSION_LEVEL=9`
- **用途**: 1最快，9最高压缩率

#### STATIC_CACHE_MAX_AGE
- **说明**: 静态文件缓存时间（秒）
- **默认值**: 86400 (24小时)
- **示例**: `STATIC_CACHE_MAX_AGE=3600`
- **用途**: 控制静态资源的浏览器缓存时间

### 10. 监控配置

#### HEALTH_CHECK_INTERVAL
- **说明**: 健康检查间隔时间（毫秒）
- **默认值**: 30000
- **示例**: `HEALTH_CHECK_INTERVAL=60000`
- **用途**: 内部健康检查的执行频率

#### HEALTH_CHECK_TIMEOUT
- **说明**: 健康检查超时时间（毫秒）
- **默认值**: 5000
- **示例**: `HEALTH_CHECK_TIMEOUT=10000`
- **用途**: 健康检查的最大等待时间

## 环境配置示例

### 开发环境 (.env.development)
```env
# 开发环境配置
NODE_ENV=development
PORT=3000
MONGODB_URI=mongodb://localhost:27017/lyl_dev
CORS_ORIGIN=*
LOG_LEVEL=debug
CONTENT_SECURITY_POLICY=false
CROSS_ORIGIN_EMBEDDER_POLICY=false
```

### 生产环境 (.env.production)
```env
# 生产环境配置
NODE_ENV=production
PORT=8080
MONGODB_URI=mongodb://user:pass@cluster.mongodb.net/lyl
MONGODB_SSL=true
CORS_ORIGIN=https://app.example.com
LOG_LEVEL=info
CONTENT_SECURITY_POLICY=true
CROSS_ORIGIN_EMBEDDER_POLICY=true
RATE_LIMIT_MAX=50
```

### 测试环境 (.env.test)
```env
# 测试环境配置
NODE_ENV=test
PORT=3001
MONGODB_URI=mongodb://localhost:27017/lyl_test
CORS_ORIGIN=*
LOG_LEVEL=warn
```

## 配置最佳实践

### 1. 安全性
- 生产环境不要使用默认密码
- 启用所有安全相关的配置
- 限制CORS源域名
- 使用强密码和SSL连接

### 2. 性能
- 根据服务器资源调整连接池大小
- 合理设置限流参数
- 优化压缩级别和缓存时间

### 3. 可维护性
- 使用有意义的配置项名称
- 添加配置项的注释说明
- 定期检查和更新配置

### 4. 环境隔离
- 不同环境使用不同的配置文件
- 敏感信息不要提交到版本控制
- 使用环境变量覆盖默认配置

## 配置验证

### 启动时验证
项目启动时会验证关键配置项：

```javascript
// 验证必需的环境变量
if (!process.env.MONGODB_URI) {
  console.error('❌ MONGODB_URI environment variable is required');
  process.exit(1);
}
```

### 运行时验证
某些配置项会在运行时进行验证：

```javascript
// 验证端口配置
const port = normalizePort(process.env.PORT || 3000);
if (!port) {
  console.error('❌ Invalid port configuration');
  process.exit(1);
}
```

## 故障排除

### 常见问题

#### 1. 配置未生效
- 检查 `.env` 文件是否存在
- 确认配置项名称正确
- 重启服务器使配置生效

#### 2. 数据库连接失败
- 检查 `MONGODB_URI` 格式
- 确认数据库服务可用
- 验证用户名密码正确

#### 3. CORS错误
- 检查 `CORS_ORIGIN` 配置
- 确认前端域名在允许列表中
- 验证请求头配置

#### 4. 限流触发
- 检查 `RATE_LIMIT_MAX` 设置
- 确认限流时间窗口合理
- 考虑调整限流策略

## 总结

环境变量配置为项目提供了灵活性和可维护性。通过合理配置，可以：

1. **提高安全性**: 启用安全特性，限制访问权限
2. **优化性能**: 调整连接池、缓存、压缩等参数
3. **简化部署**: 不同环境使用不同配置，无需修改代码
4. **增强监控**: 配置日志级别和健康检查参数

建议根据实际需求和环境特点，合理配置这些环境变量，确保项目的安全、稳定和高效运行。 