📋 项目全景分析

  一、项目概述

  项目名称: LYL API Server (my-node-server)技术栈: Node.js + Express + MongoDB + JWT版本: 1.0.0端口: 3000 (可配置)

  这是一个多功能后端API服务器,整合了以下核心业务模块:
  1. 用户系统 - 注册/登录/JWT认证
  2. 笔记管理 - 个人笔记CRUD
  3. 共享笔记 - 多人协作笔记本(支持四象限管理)
  4. 凭据管理 - 账号密码加密存储
  5. LOL游戏数据 - 英雄联盟英雄/装备/符文/攻略查询

  二、目录结构分析

  node-server/
  ├── src/
  │   ├── app.js                    # Express应用主配置
  │   ├── server.js                 # HTTP服务器启动入口
  │   ├── config/                   # 配置中心
  │   │   ├── app.js                # 应用配置(端口/CORS/限流)
  │   │   └── database.js           # MongoDB连接配置
  │   ├── middleware/               # 中间件层
  │   │   ├── authMiddleware.js     # JWT认证中间件
  │   │   ├── errorHandler.js       # 全局错误处理
  │   │   ├── logger.js             # HTTP请求日志
  │   │   └── security.js           # 安全配置(Helmet/CORS/限流)
  │   ├── models/                   # 数据模型层(Mongoose Schema)
  │   │   ├── User.js               # 用户模型(含密码加密)
  │   │   ├── Note.js               # 笔记模型
  │   │   ├── SharedNote.js         # 共享笔记本
  │   │   ├── SharedQuadrantNote.js # 四象限笔记项
  │   │   ├── Credential.js         # 凭据加密存储
  │   │   ├── Champion.js           # LOL英雄数据
  │   │   ├── Item.js               # LOL装备数据
  │   │   ├── Rune.js               # LOL符文数据
  │   │   ├── Strategy.js           # LOL攻略数据
  │   │   ├── Subject.js            # 学习科目
  │   │   └── StudyFile.js          # 学习笔记文件
  │   ├── routes/                   # 路由层
  │   │   ├── index.js              # 主路由(挂载所有子路由)
  │   │   ├── api.js                # API路由汇总(提供端点列表)
  │   │   ├── auth.js               # 认证路由
  │   │   ├── notes.js              # 笔记路由
  │   │   ├── sharedNotes.js        # 共享笔记路由
  │   │   ├── credentials.js        # 凭据路由
  │   │   ├── champions.js          # 英雄查询路由
  │   │   ├── items.js              # 装备查询路由
  │   │   ├── runes.js              # 符文查询路由
  │   │   └── strategies.js         # 攻略路由
  │   ├── scripts/                  # 数据初始化脚本
  │   │   ├── collectAllData.js     # 采集所有LOL数据
  │   │   ├── collectChampionData.js# 采集英雄数据
  │   │   └── collectItemData.js    # 采集装备数据
  │   ├── utils/                    # 工具类
  │   │   ├── asyncHandler.js       # 异步错误捕获
  │   │   ├── crypto.js             # 加密解密工具
  │   │   └── response.js           # 统一响应格式
  │   ├── validators/               # 数据验证
  │   │   └── common.js             # 通用验证规则
  │   └── assets/json/lol/          # LOL静态数据(JSON)
  │       ├── champion.json
  │       ├── items.json
  │       └── runes.json
  ├── public/                       # 静态文件目录
  ├── .env                          # 环境变量(含敏感信息)
  ├── package.json                  # 依赖配置
  └── CLAUDE.md                     # 开发规范文档

  三、核心技术架构

  3.1 技术栈依赖

  核心框架
  - express - Web应用框架
  - mongoose - MongoDB ODM
  - jsonwebtoken - JWT认证
  - bcryptjs - 密码加密

  安全防护
  - helmet - 安全HTTP头
  - cors - 跨域配置
  - express-rate-limit - API限流

  工具库
  - axios - HTTP请求(用于数据采集)
  - dotenv - 环境变量管理
  - compression - 响应压缩
  - morgan - HTTP日志

  3.2 中间件执行流程

  请求 →
    ↓ 信任代理 (trust proxy)
    ↓ Helmet安全头
    ↓ CORS跨域
    ↓ 响应压缩 (compression)
    ↓ JSON/URL解析
    ↓ HTTP日志 (morgan)
    ↓ 静态文件服务
    ↓ 全局限流 (100次/15分钟)
    ↓ API限流 (50次/15分钟)
    ↓ JWT认证 (需认证路由)
    ↓ 路由处理
    ↓ 404处理
    ↓ 全局错误处理
  → 响应

  3.3 数据库设计特点

  MongoDB连接
  - 使用 MongoDB Atlas 云数据库
  - 连接URI: mongodb+srv://admin:****@cluster0.nqhl8ap.mongodb.net/
  - 使用 Mongoose ODM 进行数据建模

  数据模型特点
  - 完整的时间戳 (timestamps: true)
  - 虚拟字段支持 (virtuals)
  - 文本索引用于搜索
  - 自定义静态方法(如 Champion.search())

  四、业务模块详解

  4.1 用户认证模块 (/api/auth)

  功能:
  - POST /api/auth/register - 注册(支持昵称nickname,生成唯一uid)
  - POST /api/auth/login - 登录(返回JWT token)
  - POST /api/auth/logout - 登出
  - GET /api/users - 获取用户列表

  特点:
  - 密码使用 bcryptjs 加密(10轮salt)
  - JWT token认证
  - 用户有唯一uid字段
  - 支持昵称(displayName)

  4.2 笔记管理模块 (/api/notes)

  功能:
  - 个人笔记的增删改查
  - 支持标题/内容/标签
  - 按用户隔离数据

  认证: ✅ 需要JWT token

  4.3 共享笔记模块 (/api/shared-notes)

  功能:
  - 多人共享笔记本管理
  - 四象限笔记项(支持x_axis/y_axis坐标定位)
  - 参与者(participants)权限控制
  - 仅创建者可删除

  特点:
  - 支持多人协作
  - 四象限管理(可能用于时间管理矩阵等场景)
  - 笔记项有顺序(order字段)

  4.4 凭据管理模块 (/api/credentials)

  功能:
  - 账号/密码/网站的加密存储
  - POST /api/credentials/:id/reveal - 解密密码

  安全特点:
  - 密码使用 AES-256-CBC 加密存储
  - 查询时不返回密码
  - 需要专门接口解密

  4.5 LOL游戏数据模块

  英雄查询 (/api/champions)

  - GET /api/champions - 英雄列表(支持搜索/标签过滤/排序)
  - GET /api/champions/:identifier - 英雄详情(支持ID/key/riotId)
  - GET /api/champions/tags/list - 获取所有标签
  - GET /api/champions/search/:keyword - 搜索英雄
  - GET /api/champions/by-tags/:tags - 按标签查询
  - GET /api/champions/stats/summary - 统计信息

  特点:
  - 完整的英雄图片资源(square/loading/splash/passive)
  - 标签分类(Assassin/Fighter/Mage/Marksman/Support/Tank)
  - 难度评级(1-10)
  - 版本管理

  装备查询 (/api/items)

  - 装备数据的增删改查
  - 装备统计信息

  符文查询 (/api/runes)

  - 符文数据查询

  攻略管理 (/api/strategies)

  - 英雄出装攻略的CRUD

  五、安全特性

  5.1 限流策略

  - 全局限流: 100次/15分钟/IP
  - API限流: 50次/15分钟/IP⚠️ 注意: 配置中全局限流设置了 100 * 10000 次,可能是测试用,生产环境需调整

  5.2 安全防护

  - Helmet 安全头(防XSS/CSRF)
  - CORS跨域控制(当前设置为 *,生产环境需限制)
  - JWT认证保护敏感接口
  - 密码/凭据加密存储
  - 请求体大小限制(1MB)

  5.3 错误处理

  - 全局异常捕获
  - 优雅关闭(SIGTERM/SIGINT)
  - 未处理的Promise rejection处理
  - 10秒强制关闭超时保护

  六、数据采集脚本

  项目包含LOL数据采集脚本:
  - npm run collect:champions - 采集英雄数据
  - npm run collect:items - 采集装备数据
  - npm run collect:all - 采集所有数据

  采集的数据存储在:
  - /src/assets/json/lol/*.json (JSON文件)
  - MongoDB数据库(通过Model存储)

  七、后续开发着手点

  7.1 立即需要优化的问题 🔴

  1. 环境变量泄露

    - .env 文件包含真实MongoDB凭据和JWT密钥
    - 建议: 从Git中移除,使用 .env.example 替代
  2. 限流配置异常

    - src/config/app.js:32 设置了 100 * 10000 次限流
    - 建议: 改为合理值(如100次)
  3. CORS配置过于宽松

    - 当前允许所有源(*)
    - 建议: 生产环境限制为前端域名
  4. 缺少学习模块路由

    - src/routes/api.js 中定义了学习模块端点,但缺少实际路由文件
    - 建议: 创建 src/routes/study.js 或移除相关API文档

  7.2 功能增强建议 🟡

  1. 数据验证

    - 目前缺少完整的输入验证
    - 建议: 引入 joi 或 express-validator 进行参数校验
  2. 单元测试

    - npm test 当前无实现
    - 建议: 使用 Jest/Mocha 编写测试
  3. API文档

    - 已有接口文档文件(API接口文档.md)
    - 建议: 集成 Swagger/OpenAPI 自动生成文档
  4. 日志持久化

    - 当前只有控制台日志
    - 建议: 使用 Winston 持久化日志到文件/云端
  5. 数据分页

    - 部分列表接口缺少分页
    - 建议: 统一添加 page/limit 参数

  7.3 性能优化建议 🟢

  1. 数据库查询优化

    - 添加必要的索引
    - 使用 lean() 减少内存消耗(已部分使用)
  2. 缓存机制

    - LOL数据变化不频繁,可缓存
    - 建议: 使用 Redis 缓存英雄/装备等静态数据
  3. 并发控制

    - MongoDB连接池配置
    - 建议: 根据负载调整 poolSize
  4. 响应压缩

    - 已启用 compression,可进一步配置阈值

  八、开发流程建议

  8.1 本地开发启动步骤

  # 1. 安装依赖
  npm install

  # 2. 配置环境变量(创建 .env 文件)
  MONGO_URI=your_mongodb_uri
  JWT_SECRET=your_secret_key
  PORT=3000

  # 3. 初始化LOL数据(可选)
  npm run collect:all

  # 4. 启动开发服务器
  npm run dev

  8.2 推荐的开发顺序

  如果你是新接手该项目,建议按以下顺序熟悉:

  1. 理解架构 (1-2小时)

    - 阅读 src/app.js 和 src/server.js 了解启动流程
    - 查看 src/routes/index.js 和 api.js 了解路由结构
  2. 运行项目 (30分钟)

    - 配置环境变量
    - 启动服务器
    - 使用 Postman/cURL 测试接口
  3. 阅读核心模块 (2-3小时)

    - 用户认证流程 (auth.js → User.js → authMiddleware.js)
    - 笔记管理 (notes.js → Note.js)
    - 凭据加密 (credentials.js → Credential.js → crypto.js)
  4. 实践开发 (按需)

    - 修复上述 🔴 标记的问题
    - 实现新功能(如学习模块路由)
    - 编写测试用例

  8.3 推荐的工具

  - API测试: Postman/Insomnia
  - 数据库管理: MongoDB Compass
  - 代码调试: VS Code + Node.js调试配置
  - 日志查看: 开发环境使用控制台,生产环境考虑 PM2

  九、项目亮点

  1. ✅ 完整的分层架构 - 路由/控制器/模型分离清晰
  2. ✅ 安全意识 - 密码加密/JWT认证/限流/Helmet
  3. ✅ 优雅关闭 - 完善的进程信号处理和资源清理
  4. ✅ 统一响应格式 - successResponse/errorResponse
  5. ✅ 详细注释 - 代码注释详尽,易于理解
  6. ✅ 多业务场景 - 覆盖笔记/凭据/游戏数据等多种场景